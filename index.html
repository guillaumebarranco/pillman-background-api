<html>
	<head>
		<title>Medocs</title>
		<meta charset="utf-8">
	</head>

	<body>
		<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
		<script>

			$(document).ready(function() {

				var urlCheckAPIExist = "https://www.open-medicaments.fr/api/v1/health",
					currentQuery = 0,
					limit = 100,
					limitPages = 100,
					page = 1,
					queries = [
						"a"
					]
				;

				// launchGetAllMedicaments(queries, limit, page, limitPages);

				getEmptyDBMedocs(100, function(medocs) {
					getAllDataMedicaments(100, medocs);
				});

				function launchGetAllMedicaments(queries, limit, page, limitPages)  {

					for(var i in queries) {

						if(queries.hasOwnProperty(i)) {
							getAllMedicaments(queries[i], limit, page, limitPages);
						}
					}
				}

				// Get medocs from Gouv API
				function getAllMedicaments(query, limit, page, limitPages) {

					$.ajax({
						url: "https://www.open-medicaments.fr/api/v1/medicaments?query="+query+"&page="+page+"&limit="+limit,
						type: "GET",
						success: function(response) {
							console.log(response);
							// getMedicament(response[0]);

							for(var i in response) {
								if(response.hasOwnProperty(i)) {
									insertMedicament(response[i]);
								}
							}

							console.log(limitPages);

							if(response.length !== 0 && page < limitPages) {
								getAllMedicaments(query, limit, page+1, limitPages);

							} else {
								currentQuery = currentQuery + 1;

								if(typeof queries[currentQuery] !== "undefined") {
									getAllMedicaments(queries[currentQuery], 20, 1, limitPages);
								}
							}

							// for(var i in response) {

							// 	if(response.hasOwnProperty(i)) {
							// 		getMedicament(response[i]);
							// 	}
							// }
						},
						error: function(error) {
							console.log('error', error)
						}
					})
				}

				// Get medocs from DB
				function getDBMedocs(limit, callback) {

					$.ajax({
						url: "serveur.php?function=getMedocs&limit="+limit,
						type: "GET",
						success: function(response) {
							console.log(JSON.parse(response));
							callback(JSON.parse(response));
						},
						error: function(error) {
							console.log('error', error)
						}
					});
				}


				// Get empty medocs from DB
				function getEmptyDBMedocs(limit, callback) {

					$.ajax({
						url: "serveur.php?function=getEmptyMedocs&limit="+limit,
						type: "GET",
						success: function(response) {
							console.log(JSON.parse(response));
							callback(JSON.parse(response));
						},
						error: function(error) {
							console.log('error', error)
						}
					});
				}

				// Get info on one medoc
				function getMedicament(medicament) {

					var id = medicament.codeCIS;

					$.ajax({
						url: "https://www.open-medicaments.fr/api/v1/medicaments/"+id,
						type: "GET",
						success: function(response) {
							console.log(response);
							// insertMedicament(medicament);
							// getCloseMedicament(response.infosGenerique.autresMedicamentsGroupe[0]);
						},
						error: function(error) {
							console.log('error', error)
						}
					});
				}

				// Insert medoc to database
				function insertMedicament(medicament) {

					var denomination = medicament.denomination;

					if(medicament.infosGenerique !== null &&typeof medicament.infosGenerique !== "undefined" && typeof medicament.infosGenerique.autresMedicamentsGroupe[0] !== "undefined") {
						denomination = infosGenerique.autresMedicamentsGroupe[0]
					}

					var data = {
						cis: medicament.codeCIS,
						name: medicament.denomination,
						function: 'insertMedoc'
					};

					$.ajax({
						url: "serveur.php",
						type: "POST",
						data: data,
						success: function(response) {
							console.log(response);
						},
						error: function(error) {
							console.log('error', error)
						}
					});
				}




				function finishUpdateMedoc() {

					var i = 1;

					setInterval(function() {

						console.log(i);
						++i;

					}, i*1000)



					setTimeout(function() {
						location.reload();
					}, 30000);
				}

				function getAllDataMedicaments(limit, medocs) {

					for(let i in medocs) {

						$.ajax({
							url: "https://www.open-medicaments.fr/api/v1/medicaments/"+medocs[i].cis,
							type: "GET",
							success: function(response) {
								// console.log(response.formePharmaceutique);

								// Forme
								if(typeof response.formePharmaceutique !== "undefined") {
									medocs[i].forme = response.formePharmaceutique;
								} else {
									medocs[i].forme = medocs[i].cis;
								}

								// Denomination
								if(typeof response.compositions[0] !== "undefined" && typeof response.compositions[0].substancesActives !== "undefined") {
									medocs[i].denomination = response.compositions[0].substancesActives[0].denominationSubstance;
								} else {
									medocs[i].denomination = medocs[i].cis;
								}

								updateMedoc(medocs[i]);

								if(parseInt(i) === limit-1) {
									finishUpdateMedoc();
								}
							},
							error: function(error) {
								console.log('error', error)
							}
						});
					}
				}


				



				function getAllFormeMedicaments(medocs) {

					for(let i in medocs) {

						// var i = 0;

						$.ajax({
							url: "https://www.open-medicaments.fr/api/v1/medicaments/"+medocs[i].cis,
							type: "GET",
							success: function(response) {
								console.log(response.formePharmaceutique);

								if(typeof response.formePharmaceutique !== "undefined") {
									medocs[i].forme = response.formePharmaceutique;
								} else {
									medocs[i].forme = medocs[i].cis;
								}

								updateMedocForme(medocs[i]);
							},
							error: function(error) {
								console.log('error', error)
							}
						});
					}
				}

				function getAllDenominationMedicaments(medocs) {

					for(let i in medocs) {

						// var i = 0;

						$.ajax({
							url: "https://www.open-medicaments.fr/api/v1/medicaments/"+medocs[i].cis,
							type: "GET",
							success: function(response) {
								console.log(response.compositions[0].substancesActives[0].denominationSubstance);

								if(typeof response.compositions[0].substancesActives !== "undefined") {
									medocs[i].denomination = response.compositions[0].substancesActives[0].denominationSubstance;
								} else {
									medocs[i].denomination = medocs[i].cis;
								}

								updateMedocDenomination(medocs[i]);
							},
							error: function(error) {
								console.log('error', error)
							}
						});
					}
				}

				function getAllDenominationMedicaments2(medocs) {

					for(let i in medocs) {

						// var i = 0;

						$.ajax({
							url: "https://medicaments.api.gouv.fr/api/medicaments/"+medocs[i].cis,
							type: "GET",
							success: function(response) {
								console.log(response.generique);

								if(typeof response.generique !== "undefined") {
									medocs[i].denomination = response.generique[0].cis;
								} else {
									medocs[i].denomination = medocs[i].cis;
								}

								updateMedocDenomination(medocs[i]);
							},
							error: function(error) {
								console.log('error', error)
							}
						});
					}
				}




				function updateMedoc(medoc) {

					console.log(medoc);

					$.ajax({
						url: "serveur.php?function=updateMedoc",
						type: "POST",
						data: medoc,
						success: function() {
							// console.log(JSON.parse(response));
						},
						error: function(error) {
							console.log('error', error)
						}
					});
				}



				function updateMedocDenomination(medoc) {

					console.log(medoc);

					$.ajax({
						url: "serveur.php?function=updateMedocDenomination",
						type: "POST",
						data: medoc,
						success: function() {
							// console.log(JSON.parse(response));
						},
						error: function(error) {
							console.log('error', error)
						}
					});
				}

				function updateMedocForme(medoc) {

					console.log(medoc);

					$.ajax({
						url: "serveur.php?function=updateMedocForme",
						type: "POST",
						data: medoc,
						success: function() {
							// console.log(JSON.parse(response));
						},
						error: function(error) {
							console.log('error', error)
						}
					});
				}

				function getCloseMedicament(medicament) {

					var id = medicament.codeCIS;

					$.ajax({
						url: "https://www.open-medicaments.fr/api/v1/medicaments/"+id,
						type: "GET",
						success: function(response) {
							console.log(response);
						},
						error: function(error) {
							console.log('error', error)
						}
					});
				}
			});
			

		</script>
	</body>
</html>
